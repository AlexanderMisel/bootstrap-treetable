/**
 * bootstrap-treetable
 * v1.0.4-beta
 * @author swifly
 * @url https://gitee.com/cyf783/bootstrap-treetable/
 */
 !function(a){"use strict";a.fn.bootstrapTreeTable=function(b,c){var d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s=a(this).data("bootstrap.tree.table");return s=s?s:a(this),"string"==typeof b?a.fn.bootstrapTreeTable.methods[b](s,c):(b=a.extend({},a.fn.bootstrapTreeTable.defaults,b||{}),s.hasSelectItem=!1,s.data_list=null,s.data_obj=null,s.hiddenColumns=[],s.lastAjaxParams,d=function(){e(),f(),h(),i(),j(),g(),s.data("bootstrap.tree.table",s)},e=function(){var c=a("<div class='bootstrap-tree-table'></div>");s.before(c),c.append(s),s.addClass("table table-hover treetable-table"),b.striped&&s.addClass("table-striped"),b.bordered&&s.addClass("table-bordered"),s.html("")},f=function(){var c,d,e,f,g;b.toolbar&&(c=a("<div class='treetable-bars pull-left'></div>"),c.append(a(b.toolbar)),s.before(c)),d=a('<div class="btn-group treetable-bars pull-right">'),s.before(d),b.showRefresh&&(e=a('<button class="btn btn-default btn-outline" type="button" aria-label="refresh" title="刷新"><i class="glyphicon glyphicon-repeat"></i></button>'),d.append(e),o(e)),b.showColumns?(f=a('<div class="btn-group pull-right" title="列"><button type="button" aria-label="columns" class="btn btn-default btn-outline dropdown-toggle" data-toggle="dropdown" aria-expanded="false"><i class="glyphicon glyphicon-list"></i> <span class="caret"></span></button></div>'),g=a('<ul class="dropdown-menu columns" role="menu"></ul>'),a.each(b.columns,function(b,c){if("selectItem"!=c.field){var d=null;"undefined"==typeof c.visible||1==c.visible?d=a('<li role="menuitem"><label><input type="checkbox" checked="checked" data-field="'+c.field+'" value="'+c.field+'" > '+c.title+"</label></li>"):(d=a('<li role="menuitem"><label><input type="checkbox" data-field="'+c.field+'" value="'+c.field+'" > '+c.title+"</label></li>"),s.hiddenColumns.push(c.field)),g.append(d)}}),f.append(g),d.append(f),p()):a.each(b.columns,function(a,b){"selectItem"!=b.field&&"undefined"!=typeof b.visible&&1!=b.visible&&s.hiddenColumns.push(b.field)})},g=function(){a.each(s.hiddenColumns,function(a,b){s.find("."+b+"_cls").hide()})},h=function(){var c,d=a("<tr></tr>");a.each(b.columns,function(b,c){var e=null;0==b&&"selectItem"==c.field?(s.hasSelectItem=!0,e=a('<th style="width:36px"></th>')):e=a('<th style="'+(c.width?"width:"+c.width:"")+'" class="'+c.field+'_cls"></th>'),e.text(c.title),d.append(e)}),c=a('<thead class="treetable-thead"></thead>'),c.append(d),s.append(c)},i=function(){var c=a('<tbody class="treetable-tbody"></tbody>');s.append(c),b.height&&c.css("height",b.height)},j=function(c){var d,e;s.data_list={},s.data_obj={},d=s.find("tbody"),e='<tr><td colspan="'+b.columns.length+'"><div style="display: block;text-align: center;">正在努力地加载数据中，请稍候……</div></td></tr>',d.html(e),b.url?a.ajax({type:b.type,url:b.url,data:c?c:b.ajaxParams,dataType:"JSON",success:function(a){k(a)},error:function(a){var c='<tr><td colspan="'+b.columns.length+'"><div style="display: block;text-align: center;">'+a.responseText+"</div></td></tr>";d.html(c)}}):k(b.data)},k=function(c){var d,e,f=s.find("tbody");return f.html(""),!c||c.length<=0?(d='<tr><td colspan="'+b.columns.length+'"><div style="display: block;text-align: center;">没有找到匹配的记录</div></td></tr>',f.html(d),void 0):(l(c),e=s.data_list["_root_"],e&&a.each(e,function(a,b){var c="row_id_"+a;m(b,1,c,"row_root")}),a.each(c,function(a,b){if(!b.isShow){var c=n(b,!1,1,"","");f.append(c)}}),s.append(f),r(),q(),g(),void 0)},l=function(c){var d=b.rootIdValue?b.rootIdValue:null;a.each(c,function(a,c){c.isShow=!1;var e="0"==c[b.parentId]||0==c[b.parentId]||null==c[b.parentId]||""==c[b.parentId];!c[b.parentId]||(d?c[b.parentId]==b.rootIdValue:e)?(s.data_list["_root_"]||(s.data_list["_root_"]=[]),s.data_obj["id_"+c[b.id]]||s.data_list["_root_"].push(c)):(s.data_list["_n_"+c[b.parentId]]||(s.data_list["_n_"+c[b.parentId]]=[]),s.data_obj["id_"+c[b.id]]||s.data_list["_n_"+c[b.parentId]].push(c)),s.data_obj["id_"+c[b.id]]=c})},m=function(c,d,e,f){var g=s.find("tbody"),h=s.data_list["_n_"+c[b.id]],i=n(c,h?!0:!1,d,e,f);g.append(i),h&&a.each(h,function(a,b){var c=e+"_"+a;m(b,d+1,c,e)})},n=function(c,d,e,f,g){var h,i;return c.isShow=!0,c.row_id=f,c.p_id=g,c.lv=e,h=a('<tr id="'+f+'" pid="'+g+'"></tr>'),i=b.expanderCollapsedClass,b.expandAll?(h.css("display","table"),i=b.expanderExpandedClass):1==e?(h.css("display","table"),i=b.expandFirst?b.expanderExpandedClass:b.expanderCollapsedClass):2==e?(b.expandFirst?h.css("display","table"):h.css("display","none"),i=b.expanderCollapsedClass):(h.css("display","none"),i=b.expanderCollapsedClass),a.each(b.columns,function(f,g){var j,k,l;if("selectItem"==g.field)s.hasSelectItem=!0,j=a('<td style="text-align:center;width:36px"></td>'),g.radio&&(k=a('<input name="select_item" type="radio" value="'+c[b.id]+'"></input>'),j.append(k)),g.checkbox&&(k=a('<input name="select_item" type="checkbox" value="'+c[b.id]+'"></input>'),j.append(k)),h.append(j);else{if(j=a('<td name="'+g.field+'" class="'+g.field+'_cls"></td>'),g.width&&j.css("width",g.width),g.align&&j.css("text-align",g.align),b.expandColumn==f&&j.css("text-align","left"),g.width&&j.css("vertical-align",g.valign),b.showTitle&&j.addClass("ellipsis"),g.formatter?j.html(g.formatter.call(this,c[g.field],c,f)):(b.showTitle&&j.attr("title",c[g.field]),j.text(c[g.field])),b.expandColumn==f)for(d?j.prepend('<span class="treetable-expander '+i+'"></span>'):j.prepend('<span class="treetable-expander"></span>'),l=0;e-1>l;l++)j.prepend('<span class="treetable-indent"></span>');h.append(j)}}),h},o=function(b){a(b).off("click").on("click",function(){s.refresh()})},p=function(){a(".bootstrap-tree-table .treetable-bars .columns label input").off("click").on("click",function(){var b=a(this);b.prop("checked")?s.showColumn(a(this).val()):s.hideColumn(a(this).val())})},q=function(){s.find("tbody").find("tr").unbind(),s.find("tbody").find("tr").click(function(){if(s.hasSelectItem){var b=a(this).find("input[name='select_item']");"radio"==b.attr("type")?(b.prop("checked",!0),s.find("tbody").find("tr").removeClass("treetable-selected"),a(this).addClass("treetable-selected")):b.prop("checked")?(b.prop("checked",!1),a(this).removeClass("treetable-selected")):(b.prop("checked",!0),a(this).addClass("treetable-selected"))}})},r=function(){s.find("tbody").find("tr").find(".treetable-expander").unbind(),s.find("tbody").find("tr").find(".treetable-expander").click(function(){var c,d,e,f=a(this).hasClass(b.expanderExpandedClass),g=a(this).hasClass(b.expanderCollapsedClass);(f||g)&&(c=a(this).parent().parent(),d=c.attr("id"),e=s.find("tbody").find("tr[id^='"+d+"_']"),f?(a(this).removeClass(b.expanderExpandedClass),a(this).addClass(b.expanderCollapsedClass),e&&e.length>0&&a.each(e,function(b,c){a(c).css("display","none")})):(a(this).removeClass(b.expanderCollapsedClass),a(this).addClass(b.expanderExpandedClass),e&&e.length>0&&a.each(e,function(c,d){var e=a("#"+a(d).attr("pid")).children().eq(b.expandColumn).find(".treetable-expander");e.hasClass(b.expanderExpandedClass)&&a(d).css("display","table")})))})},s.refresh=function(a){a&&(s.lastAjaxParams=a),j(s.lastAjaxParams)},s.appendData=function(c){a.each(c,function(c,d){var e,f,g,h,i,j,k,m,o=s.data_obj["id_"+d[b.id]],p=s.data_obj["id_"+d[b.parentId]],q=s.data_list["_n_"+d[b.parentId]],r="",t="",u=1;o&&o.row_id&&""!=o.row_id&&(r=o.row_id),p?(t=p.row_id,""==r&&(f=0,q&&q.length>0&&(f=q.length),r=p.row_id+"_"+f),u=p.lv+1,e=n(d,!1,u,r,t),g=a("#"+p.row_id).children().eq(b.expandColumn).find(".treetable-expander"),h=g.hasClass(b.expanderExpandedClass),i=g.hasClass(b.expanderCollapsedClass),h||i?h&&e.css("display","table"):g.addClass(b.expanderCollapsedClass),o?(a("#"+o.row_id).before(e),a("#"+o.row_id).remove()):(j=p.row_id.split("_"),k=p.row_id.substring(0,p.row_id.length-1)+(parseInt(j[j.length-1])+1),a("#"+k).before(e))):(e=n(d,!1,u,r,t),o?(a("#"+o.row_id).before(e),a("#"+o.row_id).remove()):(m=s.find("tbody"),m.append(e))),d.isShow=!0,l([d])}),r(),q(),g()},s.toggleRow=function(b){var c=s.data_obj["id_"+b],d=a("#"+c.row_id).find(".treetable-expander");d.trigger("click")},s.expandRow=function(b){var c=s.data_obj["id_"+b],d=a("#"+c.row_id).find(".treetable-expander"),e=d.hasClass(s.options.expanderCollapsedClass);e&&d.trigger("click")},s.collapseRow=function(b){var c=s.data_obj["id_"+b],d=a("#"+c.row_id).find(".treetable-expander"),e=d.hasClass(s.options.expanderExpandedClass);e&&d.trigger("click")},s.expandAll=function(){s.find("tbody").find("tr").find(".treetable-expander").each(function(c,d){var e=a(d).hasClass(b.expanderCollapsedClass);e&&a(d).trigger("click")})},s.collapseAll=function(){s.find("tbody").find("tr").find(".treetable-expander").each(function(c,d){var e=a(d).hasClass(b.expanderExpandedClass);e&&a(d).trigger("click")})},s.showColumn=function(c,d){var e,f=a.inArray(c,s.hiddenColumns);f>-1&&s.hiddenColumns.splice(f,1),s.find("."+c+"_cls").show(),d&&b.showColumns&&(e=a(".bootstrap-tree-table .treetable-bars .columns label").find("input[value='"+c+"']"),e.prop("checked","checked"))},s.hideColumn=function(c,d){if(s.hiddenColumns.push(c),s.find("."+c+"_cls").hide(),d&&b.showColumns){var e=a(".bootstrap-tree-table .treetable-bars .columns label").find("input[value='"+c+"']");e.prop("checked","")}},d(),s)},a.fn.bootstrapTreeTable.methods={getSelections:function(b){var c,d=b.find("tbody").find("tr").find("input[name='select_item']:checked"),e=[];return"radio"==d.attr("type")?(c=b.data_obj["id_"+d.val()],e.push(c)):d.each(function(c,d){var f=b.data_obj["id_"+a(d).val()];e.push(f)}),e},refresh:function(a,b){b?a.refresh(b):a.refresh()},appendData:function(a,b){b&&a.appendData(b)},toggleRow:function(a,b){a.toggleRow(b)},expandRow:function(a,b){a.expandRow(b)},collapseRow:function(a,b){a.collapseRow(b)},expandAll:function(a){a.expandAll()},collapseAll:function(a){a.collapseAll()},showColumn:function(a,b){a.showColumn(b,!0)},hideColumn:function(a,b){a.hideColumn(b,!0)}},a.fn.bootstrapTreeTable.defaults={id:"id",parentId:"parentId",rootIdValue:null,data:null,type:"GET",url:null,ajaxParams:{},expandColumn:0,expandAll:!1,expandFirst:!0,striped:!1,bordered:!0,columns:[],toolbar:null,height:0,showTitle:!0,showColumns:!0,showRefresh:!0,expanderExpandedClass:"glyphicon glyphicon-chevron-down",expanderCollapsedClass:"glyphicon glyphicon-chevron-right"}}(jQuery);