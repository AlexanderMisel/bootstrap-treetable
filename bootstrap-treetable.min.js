/**
 * bootstrap-treetable
 * v1.0.3-beta
 * @author swifly
 */
 !function(a){a.fn.bootstrapTreeTable=function(b,c){var d,e,f,g,h,i,j,k,l,m=a(this).data("bootstrap.tree.table");return m=m?m:a(this),"string"==typeof b?a.fn.bootstrapTreeTable.methods[b](m,c):(b=a.extend({},a.fn.bootstrapTreeTable.defaults,b||{}),m.hasSelectItem=!1,m.data_list=null,m.data_obj=null,m.hiddenColumns=[],d=function(){var c,d,e,f=a("<div class='bootstrap-tree-table'></div>");m.before(f),b.toolbar&&(c=a("<div class='treetable-bars pull-left'></div>"),c.append(a(b.toolbar)),f.append(c)),f.append(m),m.addClass("table table-hover treetable-table"),b.striped&&m.addClass("table-striped"),b.bordered&&m.addClass("table-bordered"),m.load(),b.showColumns?(d=a('<div class="btn-group treetable-bars pull-right" title="列"><button type="button" aria-label="columns" class="btn btn-default btn-outline dropdown-toggle" data-toggle="dropdown" aria-expanded="false"><i class="glyphicon glyphicon-list"></i> <span class="caret"></span></button></div>'),e=a('<ul class="dropdown-menu columns" role="menu"></ul>'),a.each(b.columns,function(b,c){if("selectItem"!=c.field){var d=null;"undefined"==typeof c.visible||1==c.visible?d=a('<li role="menuitem"><label><input type="checkbox" checked="checked" data-field="'+c.field+'" value="'+c.field+'" > '+c.title+"</label></li>"):(d=a('<li role="menuitem"><label><input type="checkbox" data-field="'+c.field+'" value="'+c.field+'" > '+c.title+"</label></li>"),m.hideColumn(c.field)),e.append(d)}}),d.append(e),m.before(d),j()):a.each(b.columns,function(a,b){"selectItem"!=b.field&&"undefined"!=typeof b.visible&&1!=b.visible&&m.hideColumn(b.field)}),m.data("bootstrap.tree.table",m)},e=function(c){var d=b.rootIdValue?b.rootIdValue:null;a.each(c,function(a,c){c.isShow=!1;var e="0"==c[b.parentId]||0==c[b.parentId]||null==c[b.parentId]||""==c[b.parentId];!c[b.parentId]||(d?c[b.parentId]==b.rootIdValue:e)?(m.data_list._root_||(m.data_list._root_=[]),m.data_obj["id_"+c[b.id]]||m.data_list._root_.push(c)):(m.data_list["_n_"+c[b.parentId]]||(m.data_list["_n_"+c[b.parentId]]=[]),m.data_obj["id_"+c[b.id]]||m.data_list["_n_"+c[b.parentId]].push(c)),m.data_obj["id_"+c[b.id]]=c})},f=function(){return m.data_list._root_},g=function(c,d,e,f,i){var j=m.data_list["_n_"+c[b.id]],k=h(c,j?!0:!1,d,e,f);i.append(k),j&&a.each(j,function(a,b){var c=e+"_"+a;g(b,d+1,c,e,i)})},h=function(c,d,e,f,g){var h,i;return c.isShow=!0,c.row_id=f,c.p_id=g,c.lv=e,h=a('<tr id="'+f+'" pid="'+g+'"></tr>'),i=b.expanderCollapsedClass,b.expandAll?(h.css("display","table"),i=b.expanderExpandedClass):1==e?(h.css("display","table"),i=b.expandFirst?b.expanderExpandedClass:b.expanderCollapsedClass):2==e?(b.expandFirst?h.css("display","table"):h.css("display","none"),i=b.expanderCollapsedClass):(h.css("display","none"),i=b.expanderCollapsedClass),a.each(b.columns,function(f,g){var j,k,l;if("selectItem"==g.field)m.hasSelectItem=!0,j=a('<td style="text-align:center;width:36px"></td>'),g.radio&&(k=a('<input name="select_item" type="radio" value="'+c[b.id]+'"></input>'),j.append(k)),g.checkbox&&(k=a('<input name="select_item" type="checkbox" value="'+c[b.id]+'"></input>'),j.append(k)),h.append(j);else{if(j=a('<td name="'+g.field+'" class="'+g.field+'_cls"></td>'),g.width&&j.css("width",g.width),g.align&&j.css("text-align",g.align),g.width&&j.css("vertical-align",g.valign),b.showTitle&&j.addClass("ellipsis"),g.formatter?j.html(g.formatter.call(this,c[g.field],c,f)):(b.showTitle&&j.attr("title",c[g.field]),j.text(c[g.field])),b.expandColumn==f)for(d?j.prepend('<span class="treetable-expander '+i+'"></span>'):j.prepend('<span class="treetable-expander"></span>'),l=0;e-1>l;l++)j.prepend('<span class="treetable-indent"></span>');h.append(j)}}),h},i=function(c){var d,i,j=m.find("tbody");return m.find("thead"),j.html(""),!c||c.length<=0?(d='<tr><td colspan="'+b.columns.length+'"><div style="display: block;text-align: center;">没有找到匹配的记录</div></td></tr>',j.html(d),void 0):(e(c),i=f(),i&&a.each(i,function(a,b){var c="row_id_"+a;g(b,1,c,"row_root",j)}),a.each(c,function(a,b){if(!b.isShow){var c=h(b,!1,1,"","");j.append(c)}}),m.append(j),l(),k(),void 0)},j=function(){a(".bootstrap-tree-table .treetable-bars .columns label input").off("click").on("click",function(){var b=a(this);b.prop("checked")?m.showColumn(a(this).val()):m.hideColumn(a(this).val())})},k=function(){m.find("tbody").find("tr").unbind(),m.find("tbody").find("tr").click(function(){if(m.hasSelectItem){var b=a(this).find("input[name='select_item']");"radio"==b.attr("type")?(b.prop("checked",!0),m.find("tbody").find("tr").removeClass("treetable-selected"),a(this).addClass("treetable-selected")):b.prop("checked")?(b.prop("checked",!1),a(this).removeClass("treetable-selected")):(b.prop("checked",!0),a(this).addClass("treetable-selected"))}})},l=function(){m.find("tbody").find("tr").find(".treetable-expander").unbind(),m.find("tbody").find("tr").find(".treetable-expander").click(function(){var c,d,e,f=a(this).hasClass(b.expanderExpandedClass),g=a(this).hasClass(b.expanderCollapsedClass);(f||g)&&(c=a(this).parent().parent(),d=c.attr("id"),e=m.find("tbody").find("tr[id^='"+d+"_']"),f?(a(this).removeClass(b.expanderExpandedClass),a(this).addClass(b.expanderCollapsedClass),e&&e.length>0&&a.each(e,function(b,c){a(c).css("display","none")})):(a(this).removeClass(b.expanderCollapsedClass),a(this).addClass(b.expanderExpandedClass),e&&e.length>0&&a.each(e,function(c,d){var e=a("#"+a(d).attr("pid")).children().eq(b.expandColumn).find(".treetable-expander");e.hasClass(b.expanderExpandedClass)&&a(d).css("display","table")})))})},m.load=function(c){var d,e,f,g;m.data_list={},m.data_obj={},m.html(""),d=a("<tr></tr>"),a.each(b.columns,function(b,c){var e=null;0==b&&"selectItem"==c.field?(m.hasSelectItem=!0,e=a('<th style="width:36px"></th>')):e=a('<th style="'+(c.width?"width:"+c.width:"")+'" class="'+c.field+'_cls"></th>'),e.text(c.title),d.append(e)}),e=a('<thead class="treetable-thead"></thead>'),e.append(d),m.append(e),f=a('<tbody class="treetable-tbody"></tbody>'),m.append(f),g='<tr><td colspan="'+b.columns.length+'"><div style="display: block;text-align: center;">正在努力地加载数据中，请稍候……</div></td></tr>',f.html(g),b.height&&f.css("height",b.height),b.url?a.ajax({type:b.type,url:b.url,data:c?c:b.ajaxParams,dataType:"JSON",success:function(a){i(a)},error:function(a){var c='<tr><td colspan="'+b.columns.length+'"><div style="display: block;text-align: center;">'+a.responseText+"</div></td></tr>";f.html(c)}}):i(b.data)},m.appendData=function(c){a.each(c,function(c,d){var f,g,i,j,k,l,n,o,p=m.data_obj["id_"+d[b.id]],q=m.data_obj["id_"+d[b.parentId]],r=m.data_list["_n_"+d[b.parentId]],s="",t="",u=1;p&&p.row_id&&""!=p.row_id&&(s=p.row_id),q?(t=q.row_id,""==s&&(g=0,r&&r.length>0&&(g=r.length),s=q.row_id+"_"+g),u=q.lv+1,f=h(d,!1,u,s,t),i=a("#"+q.row_id).children().eq(b.expandColumn).find(".treetable-expander"),j=i.hasClass(b.expanderExpandedClass),k=i.hasClass(b.expanderCollapsedClass),j||k?j&&f.css("display","table"):i.addClass(b.expanderCollapsedClass),p?(a("#"+p.row_id).before(f),a("#"+p.row_id).remove()):(l=q.row_id.split("_"),n=q.row_id.substring(0,q.row_id.length-1)+(parseInt(l[l.length-1])+1),a("#"+n).before(f))):(f=h(d,!1,u,s,t),p?(a("#"+p.row_id).before(f),a("#"+p.row_id).remove()):(o=m.find("tbody"),o.append(f))),d.isShow=!0,e([d])}),l(),k()},m.toggleRow=function(b){var c=m.data_obj["id_"+b],d=a("#"+c.row_id).find(".treetable-expander");d.trigger("click")},m.expandRow=function(b){var c=m.data_obj["id_"+b],d=a("#"+c.row_id).find(".treetable-expander"),e=d.hasClass(m.options.expanderCollapsedClass);e&&d.trigger("click")},m.collapseRow=function(b){var c=m.data_obj["id_"+b],d=a("#"+c.row_id).find(".treetable-expander"),e=d.hasClass(m.options.expanderExpandedClass);e&&d.trigger("click")},m.expandAll=function(){m.find("tbody").find("tr").find(".treetable-expander").each(function(c,d){var e=a(d).hasClass(b.expanderCollapsedClass);e&&a(d).trigger("click")})},m.collapseAll=function(){m.find("tbody").find("tr").find(".treetable-expander").each(function(c,d){var e=a(d).hasClass(b.expanderExpandedClass);e&&a(d).trigger("click")})},m.showColumn=function(c,d){var e,f=a.inArray(c,m.hiddenColumns);f>-1&&m.hiddenColumns.splice(f,1),m.find("."+c+"_cls").show(),d&&b.showColumns&&(e=a(".bootstrap-tree-table .treetable-bars .columns label").find("input[value='"+c+"']"),e.prop("checked","checked"))},m.hideColumn=function(c,d){if(m.hiddenColumns.push(c),m.find("."+c+"_cls").hide(),d&&b.showColumns){var e=a(".bootstrap-tree-table .treetable-bars .columns label").find("input[value='"+c+"']");e.prop("checked","")}},d(),m)},a.fn.bootstrapTreeTable.methods={getSelections:function(b){var c,d=b.find("tbody").find("tr").find("input[name='select_item']:checked"),e=[];return"radio"==d.attr("type")?(c=b.data_obj["id_"+d.val()],e.push(c)):d.each(function(c,d){var f=b.data_obj["id_"+a(d).val()];e.push(f)}),e},refresh:function(a,b){b?a.load(b):a.load()},appendData:function(a,b){b&&a.appendData(b)},toggleRow:function(a,b){a.toggleRow(b)},expandRow:function(a,b){a.expandRow(b)},collapseRow:function(a,b){a.collapseRow(b)},expandAll:function(a){a.expandAll()},collapseAll:function(a){a.collapseAll()},showColumn:function(a,b){a.showColumn(b,!0)},hideColumn:function(a,b){a.hideColumn(b,!0)}},a.fn.bootstrapTreeTable.defaults={id:"id",parentId:"parentId",rootIdValue:null,data:null,type:"GET",url:null,ajaxParams:{},expandColumn:0,expandAll:!1,expandFirst:!0,striped:!1,bordered:!0,columns:[],toolbar:null,height:0,showTitle:!0,showColumns:!0,expanderExpandedClass:"glyphicon glyphicon-chevron-down",expanderCollapsedClass:"glyphicon glyphicon-chevron-right"}}(jQuery);